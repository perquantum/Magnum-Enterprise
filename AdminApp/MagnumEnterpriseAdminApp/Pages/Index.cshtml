@page
@model IndexModel
@Html.AntiForgeryToken()
@{
    ViewData["Title"] = "Home page";
}

<script>
    document.addEventListener("DOMContentLoaded", () => {

        const deployBtn = document.getElementById("deployBtn");
        const overlay = document.getElementById("deployOverlay");
        const loading = document.getElementById("deployLoading");
        const success = document.getElementById("deploySuccess");

        deployBtn.addEventListener("click", async () => {
            overlay.classList.remove("d-none");
            loading.classList.remove("d-none");
            success.classList.add("d-none");

            try {
                const response = await fetch("?handler=Deploy", {
                    method: "POST",
                    headers: {
                        "RequestVerificationToken":
                            document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                const result = await response.json();

                if (result.success) {
                    loading.classList.add("d-none");
                    success.classList.remove("d-none");

                    setTimeout(() => {
                        overlay.classList.add("d-none");
                    }, 3000);
                } else {
                    alert("Deployment failed: " + result.message);
                    overlay.classList.add("d-none");
                }
            } catch {
                alert("Deployment error");
                overlay.classList.add("d-none");
            }
        });
    });
</script>

<style>
    thead th {
        white-space: nowrap;
    }

    .deploy-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255,255,255,0.9);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .d-none {
        display: none !important;
    }
</style>

<div id="deployOverlay" class="deploy-overlay d-none">
    <div class="text-center" id="deployLoading">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5>Deploying…</h5>
    </div>

    <div class="text-center text-success d-none" id="deploySuccess">
        <i class="bi bi-check-circle-fill" style="font-size:64px;"></i>
        <h4 class="mt-3">Deployment Successful</h4>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <a asp-page="/AddProduct" class="btn btn-primary">
        Add Product
    </a>

    <button type="button" id="deployBtn" class="btn btn-success">
        Deploy
    </button>
</div>

<div class="mt-4">
    <h1>Products</h1>

    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Formula</th>
                    <th>CAS Number</th>
                    <th>Purity</th>
                    <th>Molecular Weight</th>
                    <th>Density</th>
                    <th>Boiling Point</th>
                    <th>Melting Point</th>
                    <th>Category</th>
                    <th>Hazards</th>
                    <th>Storage Requirements</th>
                    <th>Image</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in Model.Products)
                {
                    <tr>
                        <td>@product.Id</td>
                        <td>@product.Name</td>
                        <td>@product.Formula</td>
                        <td>@product.CasNumber</td>
                        <td style="min-width: 100px;">@product.Purity</td>
                        <td>@product.MolecularWeight</td>
                        <td style="min-width: 150px;">@product.Density</td>
                        <td>@product.BoilingPoint</td>
                        <td>@product.MeltingPoint</td>
                        <td>@product.Category</td>
                        <td style="min-width: 300px;">
                            <ul class="mb-0">
                                @foreach (var hazard in product.Hazards)
                                {
                                    <li>@hazard</li>
                                }
                            </ul>
                        </td>
                        <td>@product.StorageRequirements</td>
                        <td class="text-center">
                            <img src="@product.ImageUrl"
                                 alt="@product.Name"
                                 style="max-width:100px; max-height:80px;"
                                 class="img-thumbnail" />
                        </td>
                        <td style="min-width: 250px;">
                            @product.Description
                        </td>
                        <td class="text-nowrap">
                            <a asp-page="/EditProduct"
                               asp-route-id="@product.Id"
                               class="btn btn-sm btn-warning me-1">
                                Update
                            </a>

                            <form method="post"
                                  asp-page-handler="Delete"
                                  asp-route-id="@product.Id"
                                  style="display:inline;"
                                  onsubmit="return confirm('Are you sure you want to delete this product?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
